레디스 클러스터의 개요와 장점, 동작 원리, 핵심기능중 하나인 장애 탐지 기능에 대해 알아보도록 한다.

## 레디스 클러스터 개요

- 여러 캐시 노드를 연결하여, 일부 장애가 발생해도 시스템을 계속 운영할 수 있도록 **페일오버** 기능을 지원한다. 
- 샤딩을 통해 노드 사이에 키를 옮길 수도 있음.
- 페일오버와 샤딩을 통해 높은 가용성을 보장하며, 쓰기 및 읽기 작업의 확장성도 높일 수 있다.
- 레디스 클러스터는 클라이언트 요청에 대해 클러스터 내 각 노드로 요청을 분배하는 과정에서 프록시를 사용하지 않으므로 프록시로 인한 오버헤드가 없다.
- 만약 데이터를 갖고 있지 않은 노드에 요청이 들어올 경우, 레디스 클러스터는 클라이언트에게 데이터를 가진 마스터 노드의 정보를 제공하고, 해당 노드로 요청을 리다이렉트한다. 이 과정에서 얻은 정보를 클라이언트가 저장하고 있다면, 다음 요청부터는 리다이렉트에 의한 오버헤드도 없앨 수 있다.
- 레디스 클러스터는 총 16,384개의 해시 슬롯이 있다.

### 레디스 클러스터가 사용하는 두 개의 TCP 포트

레디스 클러스터를 연결하기 위해서는 두 개의 TCP 포트를 사용한다. 
- 첫 번째 포트는 클라이언트로부터 TCP 연결을 받는 포트로, 6379번이 그 포트이다.
- 두 번째 포트는 클러스터 내부 통신을 위한 포트로 기본값에 +10,000을 더한 값(기본세팅의 경우 6379+10000)을 사용한다. 이를 **클러스터 버스 포트**라고 한다.
  - 통신 방식은 **가십 프로토콜**을 통해 이뤄지는데, 이 프로토콜은 클러스터의 노드 수가 증가해도, 노드 간 메시지 수가 지수적으로 증가하지 않도록 고안되었다.
  - 내부적으로는 클러스터 내의 노드 간에 설정 정보를 서로 공유하고 인지하기 위해 **Raft**라는 분산합의 알고리즘을 기반으로 시스템이 구현되어 있다.
  
### 동작 메커니즘

레디스 클러스터에서 클라이언트 요청 처리는 다음과 같은 흐름으로 진행된다.

1. 클라이언트가 클러스터를 구성하는 캐시 노드 중 하나의 IP주소에 접속
2. 접근 노드의 레플리카 마스터인 경우 다음과 같은 내용에 따라 조건 분기를 진행
   1. 접근 노드가 레플리카인 경우 
      1. 읽기 쿼리: READONLY 명령어 실행 여부에 따라 동작한다.
         1. READONLY 명령어가 실행되었고, 해당 키가 노드의 슬롯범위 내에 있는 경우 요청된 캐시노드에서 요청을 처리한다.
         2. 그 외의 경우에는 레디스 서버가 MOVED 리다이렉트를 클라이언트에 응답 -> 클라이언트가 MOVED 리다이렉트를 받고 로컬 슬롯 매핑을 업데이트 -> 클라이언트가 해당 키의 슬롯을 가진 샤드의 마스터에 접근
      2. 쓰기 쿼리: 레디스 서버가 MOVED 리다이렉트를 클라이언트에 응답 -> 클라이언트가 MOVED 리다이레그를 받고 로컬 슬롯 매핑을 업데이트 -> 클라이언트가 해당 키의 슬롯을 가진 샤드의 마스터에 접근
   2. 접속 노드가 마스터인 경우
      1. 키가 해당 캐시노의 슬롯 범위인 경우에는 요청된 마스터에서 처리
      2. 슬롯 범위 밖인 경우에는 레디스 서버가 MOVED 리다이렉트를 클라이언트에 응답 -> 클라이언트가 MOVED 리다이렉트를 받고 로컬 슬롯 매핑을 업데이트 -> 클라이언트가 해당 키의 슬롯을 가진 샤드의 마스터에 접근

즉 전체적인 동작방식은 레플리카로 접근했을 경우 데이터가 존재하지 않으면 해당 레플리카가 마스터 노드의 정보를 리다이렉트하고 마스터로 접근하게끔하여 처리하게 하는 것이다.




