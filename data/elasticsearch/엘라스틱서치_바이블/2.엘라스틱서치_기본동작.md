기본동작에 대한 챕터

### 문서 관련 명령어들

- `PUT [인덱스 이름]/_doc/[id값]` + Request Body: 문서 생성
- `POST [인덱스 이름]/_doc` + Request body : 자동으로 _id값 부여해서 문서 새성
- `GET [인덱스 이름]/_doc/[id값]`: 문서 조회
- `POST [인덱스 이름]/_update/[id값]` + Request body("doc" 포함): 문서 업데이트
- `GET [인덱스 이름]/_search` + Request Body("query", "match" 포함): 문서 검색, 특이사항으로는 `POST`로도 동작함.
  - 여기에는 score라는 유사도 항목이 존재함
- `DELETE [인덱스 이름]/_doc/[id값]`: 문서 삭제

## 엘라스틱서치 구조

- 문서(document): 엘라스틱서치가 저장하고 색인을 생성하는 JSON문서
- 인덱스: 문서를 모아 놓은 단위. 이를 기준으로 검색을 요청하게 됨.
- 샤드: 인덱스는 내용을 여러 샤드로 분산 저장함. 원본 역할을 담당하는 샤드를 **주 샤드** 복제본을 **복제본 샤드**라고함.
- 노드: 엘라스틱 서치 프로세스를 말함.
  - 노드의 역할
  - 데이터노드: 샤드를 보유하고 샤드에 실제 읽기와 쓰기 작업을 수행
  - 마스터 노드: 클러스터를 관리하는 역할
  - 조정 노드: 클라이언트의 요청을 받아서 데이터 노드에 요청을 분배하고 클라이언트에 응답을 돌려주는 노드
- 클러스터: 노드가 여러 개가 모여 구성된 것.

## 루씬

루씬은 문서를 색인하고 검색하는 라이브러리

### 루씬 flush

- 문서 색인 요청이 오면 최초 생성은 메모리 버퍼에 들어감. 업데이트, 삭제 등의 작업이 수행되면 루씬은 이러한 변경점을 메모리에 들고 있다가 주기적으로 디스크에 flush함
- 검색이 제대로 안되는 문제가 발생할 수 있는데, 루씬은 검색하려면 파일을 열어야함. 파일을 열었을 때 색인된 정보가 없으면 다시 파일을 열어야함.
- 근데 이 과정에 비용이 있기에 색인이 변경될 때마다 진행하지는 않고 적절한 간격마다 주기적으로 실행함. API로 refresh를 제공하므로 이를 사용해도 된다.

### 루씬 commit

위의 과정이 실제로 안전하게 기록되는 것까지는 보장하지는 않음. 따라서 루씬은 `fsync` 시스템콜을 통해 주기적으로 디스크와 싱크를 맞추는데 이를 **commit**이라고 함.

엘라스틱서치의 flush작업은 내부적으로 이 루씬 commit을 거침. 엘라스틱서치 refresh보다 비용이 더 많이 들며 주기적으로 실행된다. 마찬가지로 API로 제공하여 명시적으로 실행할 수 있다.


### 세그먼트

앞의 작업을 거쳐 디스크에 기록된 파일들이 모이면 **세그먼트**라는 단위가 됨. 이 세그먼트가 루씬의 검색 대상. 세그먼트는 불변이라서 업데이트가 진행되면 기존 문서를 삭제하고 새 문서를 생성한다. 기존 문서를 삭제하는 경우 삭제 플래그만 표시해두고, 루씬이 중간중간 실행하는 세그먼트 병합을 수행할 때 삭제된다. 세그먼트 병합의 경우 `forcemerge API`를 통해 명시적으로 수행도 가능하다. 

### 루씬 인덱스와 엘라스틱서치 인덱스

여러 세그먼트가 모이면 하나의 루씬 인덱스가됨. 루씬은 이 인덱스 내에서만 검색이 가능. 엘라스틱서치 샤드는 이 루씬 인덱스 하나를 래핑한 단위

엘라스틱서치 샤드가 여러개 모이면 엘라스틱서치 인덱스가 됨. 이를 통해서 여러 샤드에 있는 문서를 모두 검색할 수 있음.

### trnaslog

위에서 commit 과정까지 거쳐야 디스크에 안전하게 기록된다 하였다. 근데 commit도 큰 비용이 들기에 매 번 할 수는 없고 한 번에 모아서 하기에는 데이터 유실의 위험이 있다. 이 문제를 해결하기 위해 엘라스틱서치 샤느는 모든 작업마다 **translog** 이름의 작업 로그를 남긴다. 색인, 삭제 등의 작업이 루씬 인덱스에 수행된 직후 기록됨. 이 기록까지 완벽하게 끝나야 작업 요청이 성공으로 승인됨. 만약 엘라스틱서치에 장애가 발생한 경우 복구 단계에서 translog를 읽음. **해당 로그에 기록은 있지만 commit에 포함되지 않은 경우 복구됨.**


## 총평

이거 실습예제 인덱스 생성하지도 않고 document부터 만들라해서 조금 기분 나빴다. 그외 나머지는 평이했다. 명령어가 적은건지 많은 내용을 알려주진 않았고, 루씬의 개념과 엘라스틱서치 구조를 이해하는데 도움이 되었다.

뒤를 보고 이 챕터를 다시 봤을 때 아쉬운건 인덱스가 무엇인지? 역색인이 무엇인지에 이 장에서 설명해야하지 않나 싶다.




