# k8s 기본
- k8s의 모든 리소스는 오브젝트 형태로 관리됨.
- `.yaml` 파일을 많이 사용
- 쿠버네티스는 도커를 포함한 많은 컴포넌트가 실행됨 (API 서버, 컨트롤러 매니저, 스케줄러 등)
- kubelet이라는 에이전트가 모든 노드에서 기본적으로 실행됨. 

# Pod 개념
- 컨테이너 애플리케이션의 기본 단위
- 1개의 포드에는 1개의 컨테이너 또는 여러 개의 컨테이너가 존재할 수 있음.

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: my-nginx-pod
spec:
  containers:
  - name: my-nginx-container
    image: nginx:latest
    ports:
    - containerPort: 80
      protocol: TCP
```

- apiVersion: 오브젝트 API버전, 오브젝트 종류 및 개발 성숙도에 따라 달라질 수 있음.
- kind: 리소스 종류 
- metadata: 라벨, 주석 등 부가 정보들을 입력
- spec: 리소스 생성을 위한 자세한 정보 입력

Pod를 사용하는 이유중 하나는 포드 내의 컨테이너들이 네트워크 네임스페이스 등과 같은 리눅스 네임스페이스를 공유해 사용하기 때문이다. 예시로는 포드내 nginx컨테아너와 spring 컨테이너가 있으면 spring컨테이너 내부에서 nginx포트로 curl을 보내도 nginx에서 응답을 해준다는 것이다.

기본적으로 하나의 포드는 1개의 완전한 애플리케이션이 있어야한다.
이 뜻은 nginx같은 포드를 여러개 생성하는 것이 아닌, 사이드카 라고 불리는 nginx보조 도구들같이 메인 application에 대해서 보조해주는 도구들이나 소프트웨어를 포함해서 하나의 포드로 띄우는 것이다. 이것이 도커와의 차이점이다.

# 레플리카셋 개념

레플리카셋을 사용하는 이유는 복원력 때문이다.
동일한 여러개의 포드를 생성하고 포드가 삭제되어도 다시 생성해주는 역할도 담당해주기 때문이다.
즉, 정해진 수의 동일한 포드가 항상 실행되도록 관리하고 노드에서 장애가 나도 다른 노드에서 재생성할 수 있게끔 해준다.

레플리카셋은 라벨을 기준으로 포드를 생성하고 삭제한다.
즉, 다른 포드라도 레플리카셋이 감시하고 있는 라벨이라면 해당 포드도 레플리카셋 갯수에 포함된다. 또한 라벨을 중간에 편집하여 삭제하면 해당 라벨에 대한 포드가 1개 줄었으므로 레플리카셋이 1개 더 생성하게 된다. 이는 레플리카셋의 `selector.matchLabel`항목과 일치해야한다.

- 레플리케이션 컨트롤러 방식은 고전방식이다.
  - 레플리케이션 컨트롤러와 레플리카셋의 다른 점 중 하나는 **표현식**기반의 라벨 셀럭터를 사용.
  ```yaml
  ...
  selector:
    matchExpressions:
      - key: app
        values:
          - my-nginx-pods-label
          - your-nginx-pods-label
        operator: In
    template:
  ...
  ```
  => app:my-nginx-pods-label 라벨을 가지는 포드뿐만 아니라 app:your-nginx-pods-label이라는 라벨을 가지는 포드 또한 레플리카셋 관리하에 놓이게됨.


# Deployment 개념

레플리카셋을 운영환경에서 잘 사용하지 않는다고한다..
디플로이먼트가 레플리카셋과 포드의 정보를 정의하기에 이를 더 많이 쓴다고 한다.

디플로이먼트를 실제로 생성하게 되면 정의된 레플리카셋, 포드가 생성된다.

이렇게만 보면 레플리카셋이랑 똑같은데 디플로이먼트를 사용하는 이유는 다음과 같음.

- 레플리카셋의 변경사항을 저장하는 **리비전**을 남겨 롤백을 가능하게해줌
- 롤링업데이트와같은 배포전략을 지정할 수 있음.

이렇듯 디플로이먼트는 레플리카셋을 관리하는 상위 개념으로 더 자주 쓰이게 될 듯 하다.

# Service 개념

포드를 연결하고 외부에 노출하도록 하는 Service의 개념

디플로이먼트를 생성한다고해서 외부에서 접근이 가능한 것이 아닌데 이를 도와주는 오브젝트 개념

- 여러 개의 포드에 접근할 수 있도록 고유한 도메인 이름을 부여해줌.
- 여러 개의 포드에 접근할 때 로드밸런스 역할도 담당
- 포드를 외부에 노출시킴

서비스의 종류에 따라 포드에 접근할 수 있는 방법이 달라짐. 크게 3가지

1. ClusterIp타입: 쿠버네티스 내부에서만 포드들에 접근할 떄 사용
2. NodePort 타입: 포드에 접근할 수 있는 포트를 클러스터의 모든 노드에 동일하게 개방. 외부에서 접근 가능 
  - mac 실리콘칩은 테스트하기 좀 번거로움
  - 클러스터 IP의 기능을 포함하여 내부에서 접근도 가능
  - 실제 운영환경에서는 잘 쓰이지 않음 
    - 443, 80같은 포트를 설정하기 적절하지 않고(애초에 제한이 30000~32768), 인그레스라는 오브젝트에서 간접적으로 사용되는 경우가 많음.
  - 특정 클라이언트가 같은 포드로부터만 처리되게 하려면 옵션 지정할 수 있음 `spec.sessionAffinity: ClientIp`
3. LoadBalancer타입: 외부에서 접근이 가능하지만 일반적으로 AWS, GCP같은데서 사용. 원리는 클라우드 플랫폼에서 제공하는 로드밸런서를 동적으로 프로비저닝해 포드에 연결(뭔 말?)











