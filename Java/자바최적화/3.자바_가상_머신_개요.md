이 장에서는 자바가 자바 가상 머신에서 실행되는 방식을 소개

## 인터프리팅과 클래스 로딩

- 자바 가상 머신은 스택 기반 인터프리터 머신
    - 연산의 중간 결과를 저장하는 실행 스택을 사용하며, 스택의 최상위 값, 값들을 기반으로 계산을 수행한다는 것.  

애플리케이션 진입점은 보통 ???.class의 main()함수인데, 이를 실행하려면 자바 가상 머신이 해당 클래스를 로드해야함. 이때 **자바 클래스 로딩 메커니즘**이 사용.

초기 로더는 부트스트랩 클래스 로더이며, 핵심 자바 런타임에 필요한 클래스를 로드함. 예를 들어서 java.lang.Object, Class, ClassLoader와 같은 클래스를 불러옴.

자바 9부터 모든 자바 가상 머신은 모듈화되어 있음.
기본 시스템의 나머지 부분은 **플랫폼 클래스 로더**가 로드함.
마지막으로 **애플리케이션 클래스 로더**가 생성되어, 사용자 클래스를 로드하는 역할을 함. 만약 프로그램 실행중 새로운 클래스를 찾지 못하면 부모 클래스 로더로 작업을 위임하는데, 타고타고 가도 못 찾으면 ClassNotFoundExeception 에러가 발생함.

## 바이트코드 실행

자바 소스 코드는 실행되기 전 여러 단계의 변환 과정을 거친다. 그 중 첫 번째 단계는 자바 컴파일러 javac를 사용하는 컴파일 과정이다. **javac 역할은 자바코드를 .class파일로 변환하여 바이트 코드를 생성하는 것** 바이트코드는 특정 OS에 종속되지 않은 중간 표현이다. 때문에 하드웨어와 분리된 이식성을 지님.

모든 클래스파일은 **&CAFEBABE(매젝넘버)**로 시작한다. 이 값을 식별하여 클래스 파일형식이 올바르게 되었는지 확인한다. 그 뒤의 4바이트는 해당 클래스 파일을 컴파일하는 데 사용된 마이너 버전과 메이저 버전을 나타낸다. 만약 호환성이 맞지 않으면 UnspportedClassVersionError가 발생한다.

## 핫스팟 소개

가상 머신 중 하나인데 C나 C++로 비교할 수 있는 수준까지 끌어올림.  
**제로-코스트 추상화**란 하드웨어에 가까운 수준에서 동작하여 최대한 비용을 없애는 전략 중 하나인데, 언어 사용자가 운영 체제와 컴퓨터 저수준 동작 방식을 직접 다뤄야하는 부담을 준다. 자바는 이러한 철학을 따르지 않았는데, 대신 핫스팟 가상 머신은 프로그램의 런타임 동작을 분석하여 성능을 극대화할 수 있는 부분에 최적화를 적용하는 방식을 선택함.

## JIT 컴파일

핫스팟 가상 머신은 해석된 바이트코드를 네이티브 코드로 컴파일하여 성능을 향상시킴.
네이티브 코드는 인터프리터를 거치지 않고 직접 실행됨. 핫스팟 가상 머신에서 컴파일 단위는 메서드와 루프이며, 이 과정을 **JIT컴파일**이라고 한다.

애플리케이션에서 해석 모드에서 실행되는 동안 실행 빈도가 높은 코드 부분을 관찰하고 임계값을 초과하면, 프로파일러가 해당 코드를 컴파일하고 최적화를 적용함.

## 자바 가상 머신 메모리 관리

자바가 초기부터 주요 강점으로 내세운 기능 중 하나이다.

C,C++ 같은 메모리를 직접 할당하고 해제하는 방식과 달리 자바는 **가비지컬렉션**을 통해 자동으로 관리되는 힙 메모리를 도입하였다. 가비지 컬렉션은 실행될 때 STW(stop the world)라는 애플리케이션이 멈추는 현상 이라는 비용이 발생한다. 그럼에도 불구하고 엄청 정교한 알고리즘을 통해 정지시간이 짧도록 개선하였고, 나아가 아예 제거하는 방식으로도 발전하고 있다. 

## 스레딩과 자바 메모리 모델

옛날에는 자바 애플리케이션 스레드가 플랫폼 스레드 풀에 매핑되거나 다중화 되었다. 그러나 만족스러운 성능을 제공하지 못하고, 불필요한 복잡성을 초래했다. 때문에 애플리케이션 스레드와 플랫폼 스레드를 각각 대응시키도록 하였는데, 애플리케이션이 커지면서 스레드도 늘어나고 스레드 병목 문제가 생겼다. 이를 해결하기 위해 **룸 프로젝트**가 시작되었고, 그 결과로 나온것이 **가상 쓰레드**이다. 네트워크 I/O와 같은 많은 동시 실행 컥택스트를 필요로 하는 작업에서 강력한 성능을 발휘한다.

자바 메모리 모델(JMM)은 서로 다른 실행 스레드가 객체에 저장된 변화를 어떻게 관찰하는지 정의함. 예를 들어 스레드 A와 B가 같은 obj에 대한 참조를 가지고 있을때 A가 이를 변경하면 B가 그 변화를 어떻게 볼 수 있는지 관찰한다.
동시성 문제가 있을 수 있는데, 자바는 이를 해결하기 위해 **상호 배제 잠금**이라는 메커니즘을 제공한다. 

## 자바 가상 머신 모니터링 또는 도구

- 자바 관리 확장 프로그램(JMX)
    - 자바 가상 머신과 그 위에서 실행되는 애플리케이션을 제어하고 모니터링하기 위한 범용 기술
- 자바 에이전트
    - 클래스가 로드될 때 메서드의 바이트코드를 수정할 수 있도록 지원하는 도구 구성요소
    - 이를 통해 메서드 실행 시간 측정이나 분산 추적과 같은 계측 로직을 추가할 수 있다. 
- 자바 가상 머신 도구 인터페이스
    - 위에서 자바 에이전트를 통한 데이터 수집이 충분하지 않은 경우 좀 더 저수준으로 다가가서 데이터를 수집할 수 있음. 그렇기에 네이티브 컴파일 언어로 작성되어야하는데, 문제를 야기할 확률이 높아서 웬만하면 자바 에이전트로 해결하는게 좋음.
- 서비스 지원 에이전트
    - 자바 객체와 핫스팟 데이터 구조를 모두 노출할 수 있는 API와 도구의 집합

## 자바 구현, 배포 또는 릴리스

여러 벤더가 자바 배포 사업에 참가하고 있다. 대표적으로 오라클JDK가 있다. 다른 예로는 이클립스 어답티움, 레드햇, 아마존 코레토 등이 있다.

## 총평

3장은 전체적으로 자바가 하드웨어를 어떻게 다루는지?에 대한 내용이였다. 각 상세 내용은 뒤에 나올 내용들에서 다뤄질 예정이라 맛보기?로만 알려줬다.
그래도 이렇게 빌드업 해나가는 과정이 좋았다.