스위치는 2계층에 있기에 MAC 주소를 기반으로 동작한다.

단순히 패킷을 전달하는 동작 외에도 네트워크를 분리할 수 있는 **VLAN**기능과 네트워크 루프를 방지하는 **스패닝 트리 프로토콜(STP)**같은 기능을 제공한다. 

## 스위치 장비 동작

스위치에는 MAC 주소 테이블이 존재하여  해당 테이블을 기준으로 패킷을 전달한다.

|MAC주소|포트|
|-----|----|
|AA|Eth 1|

만약 테이블에 없는 도착지 주소를 가진 패킷이 들어오면 전체 포트로 패킷을 전송함. 패킷의 도착지 주소가 테이블에 존재하면 해당 포트로만 패킷을 보냄.

스위치 동작 방식에는 **플러딩**, **어드레스 러닝**, **포워드/필터링** 3가지로 나눌 수 있다.

### 플러딩(Flooding)

- 스위치 부팅 시 네트워크 관련 정보가 하나도 없기에 허브처럼 모든 포트로 패킷을 전달하게 된다. 이러한 동작을 **플러딩**이라고 한다.

- 공격 기법으로는 스위치에 엉뚱한 MAC 주소를 습득시키게 하거나 MAC 주소 테이블을 꽉차게 해 스위치의 플러딩 동작을 유도할 수도 있다. 또는 *ARP 포이즈닝*기법을 통해 MAC주소를 바꿔치기헤 공격자에게 패킷이 전달하게끔 하는 방법도 있다.

### 어드레스 러닝

- MAC 주소 테이블을 만들고 유지하는 과정을 **어드레스 러닝**이라고 함. 
- 출발지의 MAC주소와 포트번호를 MAC 주소 테이블에 저장함.

### 포워딩/필터링

- 패킷이 들어온 경우 스위치가 도착지 MAC 주소를 확인하고 MAC 주소 테이블과 비교해 맞는 정보가 있으면 매치되는 해당 포트로 패킷을 **포워딩**한다고 함.
- 이 과정에서 다른 포트에는 패킷을 보내지 않는데, 이를 **필터링**이라고 함.
- 일반적으로 유니캐스트에 대해서만 동작하고, 브로드캐스트, 언노운 유니캐스트, 멀티캐스트는 좀 다르게 동작한다. 

여기서 "목적지 MAC과 포트는 어떻게 아나요" 라고 물어볼 수 있는데, 이는 이전 ARP브로드캐스트를 통해 알 수 있다.

호스트는 ARP 브로드캐스트/응답 과정을 통해 목적지의 MAC 주소를 학습하여 자신의 ARP 캐시에 저장하게 되는데, 이 과정중에 스위치는 ARP 요청 및 응답 패킷이 각 포트로 들어올 때마다 해당 패킷의 출발지 MAC 주소와 수신 포트 정보를 학습하여 자신의 MAC 테이블을 갱신한다.

## VLAN(Virtual LAN)

- 하나의 물리 스위치에서 여러개의 네트워크를 나누어 사용할 수 있는 기술이다.
- 보안향상, 과도한 브로드캐스트에 의한 성능 저하 등으로 인해서 네트워크는 분리되어야한다.
- 분리된 네트워크 끼리 통신하려면 3계층 장비가 필요하다.
- 포트기반 VLAN, MAC 주소기반 VLAN이 존재한다.

### 포트기반 VLAN

스위치에 특정 포트에 VLAN ID를 할당하여 해당 포트에 연결되는 모든 장치를 지정된 VLAN에 소속시키는 방식.

예를 들어, 스위치 1번 포트가 VLAN 10에 할당되어 있다면, 어떤 PC가 1번 포트에 연결되든 VLAN 10 소속이 된다.

설정이 비교적 간단하고, 보안, 성능도 안정적이지만 포트가 고정되어 있기에 만약 사용자가 다른 포트로 이동하거나 장치를 교체하는 경우 수동으로 설정을 바꿔줘야하는 단점이 존재한다.

### MAC 주소기반 VLAN

장치가 고유한 MAC주소를 기반으로 VLAN을 할당함. 어떤 포트에 연결되든 MAC 주소에 따라 VLAN에 소속됨.

스위치가 각 장치의 MAC 주소와 주소가 속할 VLAN ID를 매핑하는 데이터베이스를 구성하여 해당 장치가 연결되었을 때 데이터베이스에서 조회하여 할당된 VLAN 장치로 소속시킴. 

포트기반과 달리 사용자가 포트를 변경하는 등의 문제에서 **유연하게 대처**가 가능하지만 **설정이 다소 복잡**하고 데이터베이스를 관리하는 **중앙 서버가 필요**하다. 또한 MAC 주소 조회 부분에서 **성능 오버헤드**가 존재하고 **MAC주소 스푸핑**(MAC Spoofing)에 취약하다.


### VLAN 모드(Trunk/Access)

스위치의 포트는 물리적 한계(포트 수, 거리)를 지니고 있고 여러 확장을 위해 스위치끼리 연결해서 사용하는 경우가 있다. 그런데 스위치 포트1개당 스위치 1개씩 연결하면 이 또한 낭비가 심하기에 이를 해결할 수 있는 방식이 나왔는데, 그중 대표적인게 트렁크 모드이다.

- 트렁크 모드
    - 여러개의 VLAN 트래픽을 동시에 전송할 수 있는 스위치 포트
    - 트렁크 포트를 통해 전송되는 프레임에는 어느 VLAN에 속하는지를 식별하기 위한 **VLAN TAG**가 추가됨. 

예) 두 스위치를 연결하는 포트를 트렁크 포트로 설정하고 VLAN 10과 VLAN 20 트래픽을 허용하면, 두 스위치 모두 VLAN 10과 VLAN 20의 통신이 가능해진다.

트렁크 포트가 아닌 일반적인 포트를 언태그포트 또는 **액세스포트**라고한다.

## STP

SPoF를 피하기 위해서 스위치 두 대로 네트워크를 구성할 수 있는데, 스위치가 포워딩 하는 과정중 모든 포트로 브로드캐스트 하는 방식 때문에 데이터 프레임이 끊임없이 순환될 수 있다.(**브로드캐스트 스톰**) 이때문에 발생하는 문제를 **네트워크 루프**라고 부른다.

3계층은 TTL이 있지만 2계층은 존재하지 않기에 죽지 않고 계속 돌게된다.

또 하나의 문제점은 **MAC 어드레스 플래핑 현상**이다. 위처럼 네트워크가 순환될 때 MAC주소 학습을 제대로 못하는 현상을 말하는데 스위치 3개(A,B,C라 가정) 이상이 순환해가면서 (스위치 A에서 출발한 패킷에 대한 응답이 B, C에서 옴.)MAC주소를 너무 빈번하게 업데이트하게 되어 발생하는 문제이다. 이 경우 스위치가 정상적으로 동작하지 못하고 패킷을 플러딩하게 된다.

이를 해결하기 위해서는 네트워크 순환이 도는곳의 핵심 포트를 찾아서 이를 막아두는 방법인데, 복잡한 네트워크 구조에서는 이를 찾기는 어렵고 한계가 명확하다. 대신 이런 루프를 자동 감지해 포트를 차단하고 우회로가 없을 때 차단된 포트를 스위치 스스로 다시 풀어주는 **스패닝 트리 프로토콜**이 개발 되었다.





