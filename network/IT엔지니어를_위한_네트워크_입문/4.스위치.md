스위치는 2계층에 있기에 MAC 주소를 기반으로 동작한다.

단순히 패킷을 전달하는 동작 외에도 네트워크를 분리할 수 있는 **VLAN**기능과 네트워크 루프를 방지하는 **스패닝 트리 프로토콜(STP)**같은 기능을 제공한다. 

## 스위치 장비 동작

스위치에는 MAC 주소 테이블이 존재하여  해당 테이블을 기준으로 패킷을 전달한다.

|MAC주소|포트|
|-----|----|
|AA|Eth 1|

만약 테이블에 없는 도착지 주소를 가진 패킷이 들어오면 전체 포트로 패킷을 전송함. 패킷의 도착지 주소가 테이블에 존재하면 해당 포트로만 패킷을 보냄.

스위치 동작 방식에는 **플러딩**, **어드레스 러닝**, **포워드/필터링** 3가지로 나눌 수 있다.

### 플러딩(Flooding)

- 스위치 부팅 시 네트워크 관련 정보가 하나도 없기에 허브처럼 모든 포트로 패킷을 전달하게 된다. 이러한 동작을 **플러딩**이라고 한다.

- 공격 기법으로는 스위치에 엉뚱한 MAC 주소를 습득시키게 하거나 MAC 주소 테이블을 꽉차게 해 스위치의 플러딩 동작을 유도할 수도 있다. 또는 *ARP 포이즈닝*기법을 통해 MAC주소를 바꿔치기헤 공격자에게 패킷이 전달하게끔 하는 방법도 있다.

### 어드레스 러닝

- MAC 주소 테이블을 만들고 유지하는 과정을 **어드레스 러닝**이라고 함. 
- 출발지의 MAC주소와 포트번호를 MAC 주소 테이블에 저장함.

### 포워딩/필터링

- 패킷이 들어온 경우 스위치가 도착지 MAC 주소를 확인하고 MAC 주소 테이블과 비교해 맞는 정보가 있으면 매치되는 해당 포트로 패킷을 **포워딩**한다고 함.
- 이 과정에서 다른 포트에는 패킷을 보내지 않는데, 이를 **필터링**이라고 함.
- 일반적으로 유니캐스트에 대해서만 동작하고, 브로드캐스트, 언노운 유니캐스트, 멀티캐스트는 좀 다르게 동작한다. 

여기서 "목적지 MAC과 포트는 어떻게 아나요" 라고 물어볼 수 있는데, 이는 이전 ARP브로드캐스트를 통해 알 수 있다.

호스트는 ARP 브로드캐스트/응답 과정을 통해 목적지의 MAC 주소를 학습하여 자신의 ARP 캐시에 저장하게 되는데, 이 과정중에 스위치는 ARP 요청 및 응답 패킷이 각 포트로 들어올 때마다 해당 패킷의 출발지 MAC 주소와 수신 포트 정보를 학습하여 자신의 MAC 테이블을 갱신한다.

## VLAN(Virtual LAN)

- 하나의 물리 스위치에서 여러개의 네트워크를 나누어 사용할 수 있는 기술이다.
- 보안향상, 과도한 브로드캐스트에 의한 성능 저하 등으로 인해서 네트워크는 분리되어야한다.
- 분리된 네트워크 끼리 통신하려면 3계층 장비가 필요하다.
- 포트기반 VLAN, MAC 주소기반 VLAN이 존재한다.

### 포트기반 VLAN

스위치에 특정 포트에 VLAN ID를 할당하여 해당 포트에 연결되는 모든 장치를 지정된 VLAN에 소속시키는 방식.

예를 들어, 스위치 1번 포트가 VLAN 10에 할당되어 있다면, 어떤 PC가 1번 포트에 연결되든 VLAN 10 소속이 된다.

설정이 비교적 간단하고, 보안, 성능도 안정적이지만 포트가 고정되어 있기에 만약 사용자가 다른 포트로 이동하거나 장치를 교체하는 경우 수동으로 설정을 바꿔줘야하는 단점이 존재한다.

### MAC 주소기반 VLAN

장치가 고유한 MAC주소를 기반으로 VLAN을 할당함. 어떤 포트에 연결되든 MAC 주소에 따라 VLAN에 소속됨.

스위치가 각 장치의 MAC 주소와 주소가 속할 VLAN ID를 매핑하는 데이터베이스를 구성하여 해당 장치가 연결되었을 때 데이터베이스에서 조회하여 할당된 VLAN 장치로 소속시킴. 

포트기반과 달리 사용자가 포트를 변경하는 등의 문제에서 **유연하게 대처**가 가능하지만 **설정이 다소 복잡**하고 데이터베이스를 관리하는 **중앙 서버가 필요**하다. 또한 MAC 주소 조회 부분에서 **성능 오버헤드**가 존재하고 **MAC주소 스푸핑**(MAC Spoofing)에 취약하다.


### VLAN 모드(Trunk/Access)

스위치의 포트는 물리적 한계(포트 수, 거리)를 지니고 있고 여러 확장을 위해 스위치끼리 연결해서 사용하는 경우가 있다. 그런데 스위치 포트1개당 스위치 1개씩 연결하면 이 또한 낭비가 심하기에 이를 해결할 수 있는 방식이 나왔는데, 그중 대표적인게 트렁크 모드이다.

- 트렁크 모드
    - 여러개의 VLAN 트래픽을 동시에 전송할 수 있는 스위치 포트
    - 트렁크 포트를 통해 전송되는 프레임에는 어느 VLAN에 속하는지를 식별하기 위한 **VLAN TAG**가 추가됨. 

예) 두 스위치를 연결하는 포트를 트렁크 포트로 설정하고 VLAN 10과 VLAN 20 트래픽을 허용하면, 두 스위치 모두 VLAN 10과 VLAN 20의 통신이 가능해진다.

트렁크 포트가 아닌 일반적인 포트를 언태그포트 또는 **액세스포트**라고한다.

## STP

SPoF를 피하기 위해서 스위치 두 대로 네트워크를 구성할 수 있는데, 스위치가 포워딩 하는 과정중 모든 포트로 브로드캐스트 하는 방식 때문에 데이터 프레임이 끊임없이 순환될 수 있다.(**브로드캐스트 스톰**) 이때문에 발생하는 문제를 **네트워크 루프**라고 부른다.

3계층은 TTL이 있지만 2계층은 존재하지 않기에 죽지 않고 계속 돌게된다.

또 하나의 문제점은 **MAC 어드레스 플래핑 현상**이다. 위처럼 네트워크가 순환될 때 MAC주소 학습을 제대로 못하는 현상을 말하는데 스위치 3개(A,B,C라 가정) 이상이 순환해가면서 (스위치 A에서 출발한 패킷에 대한 응답이 B, C에서 옴.)MAC주소를 너무 빈번하게 업데이트하게 되어 발생하는 문제이다. 이 경우 스위치가 정상적으로 동작하지 못하고 패킷을 플러딩하게 된다.

이를 해결하기 위해서는 네트워크 순환이 도는곳의 핵심 포트를 찾아서 이를 막아두는 방법인데, 복잡한 네트워크 구조에서는 이를 찾기는 어렵고 한계가 명확하다. 대신 이런 루프를 자동 감지해 포트를 차단하고 우회로가 없을 때 차단된 포트를 스위치 스스로 다시 풀어주는 **스패닝 트리 프로토콜**이 개발 되었다.

전체적인 스위치 연결 상황을 파악하기 위해 스위치는 **BPDU(Bridge Protocol Data Unit)** 프로토콜을 통해 스위치 간 통신을 하고 루프 구간을 확인 한다. 루프 지점을 확인하면 해당 지점에 트래픽을 차단시켜 루프를 예방시켜버린다.

신규 스위치가 연결된 경우 STP가 동작중인 경우 바로 연결시키지 않고 BPDU를 통해 루프지점인지 확인하고 통신할지 말지를 결정한다. 이 결정하는 과정은 4단계로 구성된다.

1. Blocking: 패킷 데이터를 차단한 채로 상대방이 보내는 BPDU를 기다린다. 2초 주기로 10번 기다린다.
2. Listening: 자신의 BPDU정보를 상대방에게 전송하기 시작
3. Learning: MAC주소 러닝단계
4. Forwarding: 패킷을 포워딩함. 

스위치는 매우 방어적으로 동작하기에 4단계가 약 50초가 소요된다.

### 동작방식

용어에 트리가 있어서 트리구조 형태로 동작한다. 뿌리가 되는 가장 높은 스위치를 선철하고 그 스위치를 통해 BPDU가 교환되도록 하는데, 뿌리가 되는 스위치를 **루트 스위치**라고 한다. 처음에는 모든 스위치가 자신을 루트 스위치라고 인식해 동작하게 된다. BPDU를 통해 브릿지ID를 비교하여 값이 더 적은 스위치를 루트스위치로 선정한다.(우선순위값이 더 낮은 스위치라고함.)

### 향상된 STP(RSTP, MST)

STP를 통해 포워딩 상태로 변경될 떄까지 약 30~50초가 소요되기에 향상된 기술들이 나왔다.

- RSTP: STP는 스위치가 추가되면 말단부터 루트, 루트부터 말단까지 변경에 대한 정보를 한 LEVEL씩 전파하느라 느렸는데, RSTP는 변경이 일어난 스위치 자신이 모든 네트워크에 직접 변경에 대한 정보를 전파하기에 빠르다.(약 2~3초 소요)
    - 다양한 BPDU 메시지, 대체 포트 개념, 토폴로지 변경 전달방식 변화
- MSTP: 기존 STP는 하나의 도메인에 대해서 **단 하나의 스패닝 트리 인스턴스**를 생성하여 사용하는데, 비효율적인 대역폭 및 로드밸런싱 어려움 등의 문제가 있었음. 이를 해결하기 위해 여러 개의 VLAN을 그룹화하여 스패닝 트리 인스턴스에 매핑하고, 각 인스턴스마다 **독립적인 스패닝 트리를 운영**한다.
    - 각 스위치에서 영역이름, 리비전 번호, 매핑정보 등을 일치시켜 활성화시킴.
    - 전체 네트워크에 대한 CIST계산을 진행 후 CIST 루트 브릿지 선출
    - 각 MST 영역 내부에서 정의된 MSTI별로 독립적인 스패닝 트리 계산. 이 과정에서 MSTI별 루트 브릿지 선출
    - 각 MSTI내에서 STP/RSTP와 유사한 방식으로 4단계의 과정을 거치며 트래픽을 전달하거나 차단, RSTP기반으로 속도는 빠름.



## 총평

스위치에 대한 내용 좋았다. 부족하거나 이해안되는 부분은 LLM으로 채웠다.

슬슬 '이거 네트워크 관리자 영역인가?' 싶었다.