## 로드 밸런서

보통 웹 애플리케이션에서 쓰이는 그 로드밸런서를 의미한다.

로드 밸런서는 4계층과 7계층에서 동작할 수 있다.

- L4로드 밸런싱: 일반적인 로드밸런서가 동작하는 방식. TCP, UDP 정보 기반으로 로드 밸런싱을 수행. 
    - 예) AWS - NLB(Network Load Balancer)
- L7로드 밸런싱: HTTP, FTP와 같은 프로토콜 정보를 기반으로 로드 밸런싱 수행. 헤더 정보나 URI같은 정보를 기반으로 부하분산을 진행한다. 이런 장비를 **ADC(Application Delivery Controller)**라고 하며 프록시 역할을 수행한다. 
    - 예) AWS - ALB(Application Load Balancer)

### L4 스위치

4계층에서 동작하면서 로드 밸런서 기능이 있는 스위치. 부하 분산, 성능 최적화, 리다이렉션 기능을 제공.

### ADC(Application Delivery Controller)

애플리케이션 꼐층에서 동작하는 로드 밸런서. 캐싱, 압축, 페일오버, 콘텐츠 변환 및 재작성, 인코딩 변환 등이 가능.

## 방화벽

네트워크 중간에 위치해 트래픽을 사전에 주어진 정책 조건에 맞추어 허용하거나 차단하는 장비

- SPI(Stateful Packet Inspection)엔진을 기반으로 동작한다.
- 세션 정보를 장비 내부에 저장한다. 이를 참조해 패킷이 외부에서 처음 시작된 것인지, 내부 사용자가 외부로 요청한 응답인지 가려낸다.


## 4계층 장비를 통과할 때의 유의점

세션 장비의 세션 타임아웃값이 애플리케이션의 세션 타임아웃값보다 짧으면 통신의 문제가 생김.

ex) 3-hand-shake 예시

1. 출발지에서 데이터 보냄
2. 세션 테이블에 정보 기록
3. 목적지에서 세션테이블을 참조하고 ACK를 보냄
4. 출발지에서 Ack를 받고 다시 ACK를 보내려고 세션 테이블을 참조하려는데 그 사이에 세션 테이블에서 세션이 만료됨.  -> DROP, 문제

이런 경우, 다양하게 해결이 가능하다.

- 세션 만료 시간 증가
    - 세션 장비 운영자가 애플리케이션에 맞게 세션 만료시간을 늘려버림.
- 방화벽을 건드려서 세산만료시에도 패킷을 들여보내게함.
    - 보안에 취약
- 세션 장비에서 세션 타임아웃 시 양 단말에 세션 종료 통보(RST 패킷)
    - 이후 통신이 필요하면 새로운 세션을 맺어서 통신
- 패킷을 주기적으로 보냄.
    - 계속해서 더미 패킷을 보내 세션 타잉아웃 방지
    - **가장 바람직한 방법**이라고함.

### 비대칭 경로 문제

- 대칭 경로: 인바운드와 아웃바운드 패킷이 **같은 장비**를 통과
- 비대칭 경로: 인바운드와 아웃바운드 패킷이 서로 **다른 장비**를 통과

예를 들어 패킷이 방화벽1를 통과해서 목적지에 도달하고 응답이 올 떄도 해당 방화벽을 타고 온다면 대칭 경로. 응답이 만약 방화벽2와 같은 다른 경로로 나가면 비대칭 경로라고함.

비대칭 경로의 문제점은 **세션 정보 불일치**와 성능저하 및 보안 약화에 있다.

문제 해결을 위해서는 세션 동기화 방법을 통해 세션 정보 불일치 문제를 해결할 수는 있으나 결국 동기화 시간보다 응답시간이 더 빠르면 정상적으로 응답하지 않을 수 있다.

다른 방법으로는 강제로 경로를 일치시키는 방법도 있다.

### 한 통신에 2개 이상의 세션을 사용하는 경우

일반적으로 한 통신에는 한 개의 세션을 사용하지만 특이하게 2개의 세션을 사용하는 경우가 있다. **FTP** 프로토콜이 그 예이며, 컨트롤 프로토콜과 데이터 프로토콜로 나뉘어 동작한다. 데이터 프로토콜은 데이터를 실어 나르는 역할을 하며, 컨트롤 프로토콜은 데이터가 잘 전송되도록 제어하는 역할을 한다.

## 후기

로드밸런서는 웹 개발 하면서 많이 접할 수 밖에 없다. 때문에 이해하는데 큰 어려움은 없었다.

내용이 생각보다 가볍다고 느껴지기도 했지만 이정도면 뭐.. 괜찮지 않나 싶기도 했다. 

FTP 동작방식에 대한 내용도 있었는데, 그냥 읽고 정리하지는 않았다. 뭔가 흐름이 이상한 느낌(?)이라서 그랬다.

그래도 알아두면 좋을 것 같았다.




