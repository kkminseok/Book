항상 설정파일을 jar에 포함시키거나 외부설정파일을 애플리케이션이 시작될 때 로드하여 사용하였는데,

책에서는 외부 설정 서버를 따로 둬서 로드하는 것 같아서 그 방식이 궁금한 챕터이다.

기존 방식의 가장 불편한 점이 환경에 따라 빌드 후 실행되기 전까지는 어떤 동작을 하는지 모른다는 점이다.

이를 해결할 수 있는지 중점적으로 확인해볼 예정이다.

스프링 애플리케이션 환경의 두 가지 주요 측면이 있다. 속성과 프로파일이다.

프로파일은 단순하게 런타임에 로드될 수 있는 설정데이터들이다.

속성에는 우선순위가 있고 책에도 설명하고 있는데, 구글에 검색하면 잘 나오니 참고하면 될 듯 하다.

서버 설정을 가져오는 방법을 설명하고 있다.

1. `Environment` 인터페이스를 이용하여 가져옴
2. `@Value{}`애노테이션 사용
3. `@ConfigurationProperties`로 가져오기 - 권장방식

## @ConfigurationProperties 사용해보고

확실히 유지보수가 다르다. `spring-boot-configuration-processor`와 연계하면 IDE에서도 속성에 대한 설명 메시지 및, 유형검사도 가능하다.


![](img/4_config.png)

이렇듯 자동완성 기능으로 사용자의 실수를 줄일 수 있다는 것은 큰 장점인 것 같다.

해당방식을 사용할 때 혹여나 set()함수와 get()함수를 제대로 작성하지 않으면 설정한 값이 Null로 나오므로 주의해야한다.

## 프로파일에 관하여

프로파일을 사용해서 빈을 조건부로 로드하는 것은 **실수**라고 칭한다.
그 이유는 애플리케이션이 환경과 결합되기 때문이다.

또한 프로파일을 기능 플래그 느낌으로 사용할 수 있는데, 책에는 `testdata`라는 프로파일명으로 이 프로파일이 활성화되면 테스트 데이터를 불러오게끔 로직을 구성하였다.

즉, 배포 환경에 제약이 없이 기능 플래그 용도로 사용할 수 있다.

그저 프로파일을 설정 그룹으로 사용하는줄 알았는데, 다른 방법으로도 사용할 수 있다는 것을 알았다.

책에서는 또한 환경변수를 통해 외부화된 설정을 사용하라고 한다.

가진 이점으로는 모든 운영체제가 환경변수라는 개념이 있기에 이식성이 좋다고 한다.
또한 명령어 실수를 할 경우가 더 적다고 한다.

내 걱정으로는 이식할 때 환경변수가 정말 동일하게 있어서 잘 동작할까? 에 대한 의문이 생기긴했다. 이를 관리하는 서버가 필요할 것 같다고는 생각했다.
또한 앞에서 말한 런타임에 설정데이터를 로드할 수 있는 능력, 설정 암호화에 대한 문제를 해결할 수 있을까에 대한 고민도 생겼다.

스프링 생태계는 이런 문제를 다룰 수 있는 방법을 가지고 있다.

3가지 분류로 나눌 수 있다는데,

- 1. 설정 서비스: 자기 자신만의 설정 서비스를 실행하고 애플리케이샨을 설정하는 데 사용할 수 있는 모듈을 제공한다.
  - 스프링 클라우드 알리바바: nacos를 데이터 자정소로 사용하는 설정 서비스 제공
  - 스프링 클라우드 컨피그: 깃 저장소, 데이터 저장소같이 장착 가능한 데이터 소스에 의해 지원되는 설정 서비스를 제공.
  - 스프링 클라우드 콘술: 하시코프 콘술을 데이터 저장소로 사용하는 설정 서비스를 제공
  - 스프링 클라우드 볼트: 하시코프 볼프를 데이터 저장소로 사용하는 설정 서비스를 제공
  - 스프링 클라우드 주키퍼: 주키퍼를 데이터 저장소로 사용하는 설정 서비스 제공

나는 회사에서 스프링 클라우드 알리바바를 사용중인데, 중국 기술이라 레퍼런스 읽기도 힘들고 설정서비스로 사용한다기보다 서비스 디스커버리로 사용하고 있다.

- 2. 클라우드 공급업체 서비스: 클라우드 공급업체가 제공하는 플랫폼에서 애플리케이션을 실행할 때 이들 업체가 제공하는 설정 서비스의 사용을 고려하는 것
  - 스프링 클라우드 aws: aws 파라미터 스코어 등과 같은 통합을 제공
  - 스프링 클라우드 애저: 애저 키 볼트와의 통합 제공
  - 스프링 클라우드 GCP: GCP 비밀관리자와 통합을 제공

- 3. 클라우드 플랫폼 서비스: 쿠버네티스 플랫폼에서 애플리케이션을 실행할 때 컨피그맵, 시크릿을 사용해 스프링 부트를 설정

책에서는 **스프링 클라우드 컨피그**를 통하여 중앙식 설정서버를 구현한다.

깃 저장소에 저장된 설정 데이터를 모든 애플리케이션에 전달해야한다는 책임이 있다.

## 스프링 클라우드 컨피그

처음 사용해보는 기술이였다.

서버 설정을 외부에서 관리함 + 동적으로 서버를 띄우지않고 설정파일 적용 가능은
정말 큰 메리트로 다가왔다.

다만 현재 실무에 적용하기에는 어렵다고 판단하였다.

실제 실무에서는 properties를 내부 github에 저장하고 있고,각 환경마다 방화벽이 설정되어 있는데 환경마다 방화벽을 해제하고 설정파일을 가져오는 것에도 리소스가 들고 모든 설정들을 한 레포지토리에 두는것도 리소스였다. 좀 더 세심하게 관리할 필요가 있다는 느낌? 그리고 깃허브 레포지토리에서 정보를 가져오는데, 깃 서버가 잠시 중단되었을 경우 대처도 따로 해줘야하는건 유의해야겠더라.

**동적으로 설정 변경이 가능하다**는 것은 엄청난 메리트이므로 이는 인지하고 앞으로 개발을 진행해야겠다.