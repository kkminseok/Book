알림 서비스는 기동 시간 모니터링용이 아니다. 
알림 서비스는 이메일, SMS와 같은 메시징 서비스 위에 구축된 계층일 가능성이 높기에 모니터링과 혼동하면 안 된다.

알림 서비스에서는 세 가지 주요 사용자 역할이 있다.

1. 발신자: 알림을 CRUD하고 수신자에게 보내는 사람이나 서비스
2. 수신자: 알림을 받는 앱의 사용자.기기나 앱 자체가 될 수도 있다.
3. 관리자: 알림 서비스 관리자 접근 권한이 있는 사람. 

### 기능적 요구사항

- 브라우저, 이메일, SMS, 자동 전화 등과 같은 다양한 채널을 통해서 알림을 보낼 수 있어야한다. 알림 서비스는 각 채널에 메시지를 보내는 서비스와 통합 되어야 한다.
- 알림 서비스는 템플릿을 가질 수 있다. SMS에는 발신자 전화번호 필드, 수신자 전화번호 필드, 본문 필드 등이 있을 것이다.
- 알림 서비스의 트리거 조건에는 수동으로 알림을 발송하는 웹 페이지, 자동화 방식 등 다양한 방식이 있을 수 있다.
- 한 명 이상의 알림을 보내고자 할 때 수신자 그룹을 관리하는 기능을 제공해야할 수 있다. 
- 기타 요구사항으로는 다음이 있다.
    - 중복 알림 요청을 식별하고 알림을 중복해서 보내지 않는다.
    - 알림 히스토리를 볼 수 있어야 한다.
    - 사용자는 다양한 템플릿을 가질 수 있다.
    - 사용자는 알림 상태를 조회할 수 있다.
    - 시스템 우선순위가 높은 알림을 낮은 것보다 먼저 처리하는 등의 우선순위를 지정할 수도 있다.


초기 구축사항으로는 동기적 방식으로는 확장성에 한계를 가지므로, 비동기식으로 구성해야하기에 카프카 같은 이벤트 큐를 사용할 수 밖에 없다.

카프카가 채널마다 토픽을 구성하고 소비자는 채널에 맞게 구독하고 소비자가 외부 알림 서비스를 통해서 알림을 보내던가 하는 등의 기능을 구성하면 된다.

채널마다 서비스를 다르게 가져가는 이유는 채널마다 프로토콜과 요구사항이 다르기 때문이다. 

이벤트를 전달할 때 비디오 파일이나 용량이 큰 이미지를 넘기는 등 객체를 넘겨야하는 경우에는 객체 스토리지를 사용하여 해결할 수 있다.

너무 큰 데이터는 주고 받기에는 오버헤드가 크다. 때문에 먼저 publisher에서 객체 스토리지에 파일을 올리고 객체 Id를받아, 소비자가 객체Id를 받고 객체 스토리지에 접근해서 처리하는 방식이다.

템플릿 서비스를 추가해서 템플릿에 관련한 데이터를 저장하고 생성할 수 있다. 만약 이렇게 구성한다면 알림Id는 알림 템플릿 키로도 활용할 수 있다.

알림 수신자 그룹을 만들었을 때 한 번에 너무 많은 수신자에게 알림을 보내는건 아닌지 관리자의 승인이 필요할 수도 있다. 즉, 사전 승인 시스템도 만들어 지는 것이다.

구독취소와 같은 알림 제외 기능은 클라이언트에서만은 구현할 수 없다. ios, 안드로이드는 이를 구현할 수 있지만 SMS, 이메일 등과 같은 채널은 클라이언트 사이드에서 막을 수 없다.

-----

### 실패한 전달 처리

알림 전달은 알림 서비스와 무관한 이유로 실패할 수 있다.

- 수신자의 기기에 연락할 수 없었다. 
    - 네트워크 이슈
    - 수신자 기기가 꺼져 있음.
    - 타사 전달 서비스의 장애
    - 앱 사용자가 앱 제거했거나 계정 취소 등
- 수신자가 알림 자체를 차단, 수신자의 기기가 알림을 차단 등

보통 알림 이벤트에 재시도를 추가하여 재시도를 진행하고, 데드 레터 큐에서 알림을 생성하고 소비하여 요청을 재시도할 수도 있다.

-----

### 중복 알림 피하기

중복 알림을 피하는 방법 중 하나는 클라이언트에서 pull방식으로 중복 알림을 감지하는 방법이 있다. 클라이언트는 알림 받은 여부를 로컬 스토리지 등에 저장하여 알림을 받기 전에 받은 알림이 존재하는 지 확인한다.

-----

알림에 필요한 모니터링과 경보를 만들 수도 있겠다.

성공, 실패율 외에도, 큐의 이벤트 수와 시간에 따른 이벤트 크기 백분위수를 채널과 우선순위 별로 분류한 것, CPU, 메모리 등 OS 통계도 포함될 수 있다.

## 총평

뭔가 알림 시스템은 간단히 넘어가게 된 것 같다. 큰 내용이 있을 줄 알았지만 그렇게 많은 내용이 다뤄지지는 않았다.



